<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¸éš†æ™ºæ…§è¾²å ´ | IndexedDB é›¢ç·š APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQy2B-um_b2YfSJ4P53MlsvdfriQi36jo",
            authDomain: "pig-expert-2025.firebaseapp.com",
            projectId: "pig-expert-2025",
            storageBucket: "pig-expert-2025.firebasestorage.app",
            messagingSenderId: "7763114998",
            appId: "1:7763114998:web:0a2215a56ee8cbd089a5d7"
        };

        // --- ç®¡ç†å“¡èˆ‡è³‡æ–™åº«é…ç½® ---
        const SPREADSHEET_ID = '1Q_xd4aNarphGl_7REybhYsp4mRNvCbWXeqDgts89w2k'; 
        const TAB_WBS = 'Batch_WBS'; 
        const TAB_STAFF = 'Staff_Config';
        const TAB_LIBRARY = 'SOP_Library'; 
        const MASTER_PASSCODE = "YL2025";
        window.BATCH_ANCHOR_DATE = "2025-12-08"; 

        // ==========================================
        // ğŸ› ï¸ [åº•å±¤ä»£ç¢¼ï¼šIndexedDB ç®¡ç†å™¨]
        // ==========================================
        class YL_LocalDB {
            constructor() {
                this.dbName = "YL_Farm_DB";
                this.version = 1;
                this.storeName = "WBS_Cache";
                this.db = null;
            }

            // åˆå§‹åŒ–è³‡æ–™åº«
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: "id" });
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°
            async save(key, data) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], "readwrite");
                    const store = transaction.objectStore(this.storeName);
                    store.put({ id: key, content: data, timestamp: Date.now() });
                    transaction.oncomplete = () => resolve(true);
                    transaction.onerror = (e) => reject(e.target.error);
                });
            }

            // å¾æœ¬åœ°è®€å–è³‡æ–™
            async get(key) {
                if (!this.db) await this.init();
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.storeName], "readonly");
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result ? request.result.content : null);
                    request.onerror = () => resolve(null);
                });
            }
        }

        const localDB = new YL_LocalDB();
        window.localDB = localDB;

        // --- Firebase åˆå§‹åŒ– ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.db = db;
        window.firebaseModules = { doc, setDoc, updateDoc, onSnapshot, collection };

        // å•Ÿå‹• Firebase å…§å»ºé›¢ç·šæŒä¹…åŒ– (åŸºæ–¼ IndexedDB)
        try {
            await enableIndexedDbPersistence(db);
            console.log("Firebase é›¢ç·šåŒæ­¥å·²å°±ç·’");
        } catch (err) {
            console.warn("Firestore æŒä¹…åŒ–å—é™:", err.code);
        }

        let masterTasks = [];
        let staffMapping = {}; 
        let sopLibraryData = {}; 
        let dailyProgress = {};
        window.selectedDate = new Date().toISOString().split('T')[0]; 
        window.viewMode = 'daily'; 
        window.unsubscribeDaily = null;

        const MODULE_MAP = {
            "1.0": { title: "ç¹æ®–èˆ‡å¥³è±¬ç®¡ç†", color: "text-rose-600", bgColor: "bg-rose-50" },
            "2.0": { title: "åˆ†å¨©èˆ‡å“ºä¹³æ¨¡çµ„", color: "text-indigo-600", bgColor: "bg-indigo-50" },
            "3.0": { title: "è‚²æˆè‚¥è‚²èˆ‡æ±¡æ°´", color: "text-emerald-600", bgColor: "bg-emerald-50" },
            "4.0": { title: "ç”Ÿç‰©å®‰å…¨èˆ‡è—¥æ”¿", color: "text-violet-600", bgColor: "bg-violet-50" },
            "5.0": { title: "ä¾›æ‡‰éˆèˆ‡é£¼æ–™", color: "text-amber-600", bgColor: "bg-amber-50" },
            "6.0": { title: "å‹•åŠ›è¨­å‚™èˆ‡ç¶­è­·", color: "text-slate-600", bgColor: "bg-slate-50" }
        };

        const STAFF_ROLES = [
            { id: "sow_lead", name: "æ¯è±¬çµ„é•·", icon: "heart", color: "text-rose-600", bgColor: "bg-rose-50" },
            { id: "nursery_manager", name: "å ´é•·/ä¿è‚²çµ„é•·", icon: "baby", color: "text-emerald-600", bgColor: "bg-emerald-50" },
            { id: "porker_lead", name: "è‚‰è±¬çµ„é•·", icon: "droplets", color: "text-blue-600", bgColor: "bg-blue-50" },
            { id: "support", name: "æ”¯æ´/æ©Ÿå‹•çµ„", icon: "shield", color: "text-violet-600", bgColor: "bg-violet-50" }
        ];

        const WEEK_LOGIC = [
            { id: 0, name: "é…ç¨®é€± (Breeding)", desc: "é‡å¿ƒï¼šå…¬è±¬æ¡ç²¾ã€æ¯è±¬å¤§é…ç¨®ã€é€²å…¥ç”¢æˆ¿æº–å‚™", class: "batch-breeding" },
            { id: 1, name: "åˆ†å¨©é€± (Farrowing)", desc: "é‡å¿ƒï¼šæ¸¬å­•ã€ä¿è‚²èˆä¸‹é«˜åºŠã€è¿æ¥å¤§åˆ†å¨©", class: "batch-farrowing" },
            { id: 2, name: "é›¢ä¹³é€± (Weaning)", desc: "é‡å¿ƒï¼šä¿è‚²èˆæº–å‚™ã€ä»”è±¬é›¢ä¹³ã€æ¸…æ´—ç”¢æˆ¿", class: "batch-weaning" }
        ];

        const DAY_NAMES = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

        // --- ç¶²è·¯ç›£æ§ ---
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        function updateOnlineStatus() {
            const dot = document.getElementById('network-status-dot');
            const text = document.getElementById('network-status-text');
            if (navigator.onLine) {
                dot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                text.innerText = "é€£ç·šåŒæ­¥ä¸­";
            } else {
                dot.className = "w-2 h-2 rounded-full bg-slate-400";
                text.innerText = "é›¢ç·šä½œæ¥­ä¸­";
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        window.calculateCurrentWeek = function(targetDateStr) {
            const anchor = new Date(window.BATCH_ANCHOR_DATE);
            const target = new Date(targetDateStr);
            const diffTime = target.getTime() - anchor.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const dayInCycle = ((diffDays % 21) + 21) % 21;
            return { weekNum: Math.floor(dayInCycle / 7), dayOfWeek: target.getDay() };
        }

        function normalizeRoles(roleData) {
            if (Array.isArray(roleData)) return roleData;
            if (typeof roleData === 'string' && roleData.trim() !== "") return roleData.split(',').map(r => r.trim());
            return [];
        }

        async function loadAllData() {
            const { doc, onSnapshot } = window.firebaseModules;
            
            // å„ªå…ˆå¾æœ¬åœ° IndexedDB å˜—è©¦æ¢å¾©ç·©å­˜ (è®“å†·å•Ÿå‹•æ›´å¿«)
            const cachedConfig = await localDB.get("master_config");
            if (cachedConfig) {
                masterTasks = cachedConfig.tasks || [];
                staffMapping = cachedConfig.staff || {};
                sopLibraryData = cachedConfig.library || {};
                renderSystem();
                document.getElementById('local-status-dot').className = "w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.5)]";
            }

            // ç›£è½é›²ç«¯å³æ™‚æ›´æ–°
            onSnapshot(doc(window.db, 'artifacts', 'yl-command', 'public', 'data', 'master_tasks', 'config'), async (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    masterTasks = data.tasks || [];
                    staffMapping = data.staff || {}; 
                    sopLibraryData = data.library || {};
                    // æ›´æ–°æœ¬åœ°å‚™ä»½
                    await localDB.save("master_config", data);
                    document.getElementById('local-status-dot').className = "w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.5)]";
                    renderSystem();
                } else if (!cachedConfig) {
                    renderEmptyState();
                }
            });
        }

        window.loadDailyStatus = function(dateStr) {
            const { doc, onSnapshot } = window.firebaseModules;
            if (window.unsubscribeDaily) window.unsubscribeDaily();
            const docRef = doc(window.db, 'artifacts', 'yl-command', 'public', 'data', 'daily_status', dateStr);
            window.unsubscribeDaily = onSnapshot(docRef, (snap) => {
                dailyProgress = snap.exists() ? snap.data() : {};
                renderSystem();
            });
        }

        window.toggleTask = async function(taskId) {
            const { doc, setDoc } = window.firebaseModules;
            dailyProgress[taskId] = !dailyProgress[taskId];
            const docRef = doc(window.db, 'artifacts', 'yl-command', 'public', 'data', 'daily_status', window.selectedDate);
            // æ­¤è™•å³ä½¿é›¢ç·šä¹Ÿæœƒå…ˆå­˜åœ¨ Firestore æœ¬åœ°å¿«å–ï¼Œé€£ç·šå¾Œè‡ªå‹•åŒæ­¥
            await setDoc(docRef, dailyProgress);
        };

        window.requestSync = async function() {
            const btn = document.getElementById('sync-btn');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> æ­£åœ¨è·¨åˆ†é åŒæ­¥...`;
            lucide.createIcons();
            try {
                const fetchCSV = async (tab) => {
                    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${tab}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    return text.split('\n').map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim()));
                };
                const [wbsRows, staffRows, libRows] = await Promise.all([fetchCSV(TAB_WBS), fetchCSV(TAB_STAFF), fetchCSV(TAB_LIBRARY)]);
                const newTasks = wbsRows.slice(1).map((row, index) => ({
                    id: `id_${row[3] || index}`, week: parseInt(row[0]), day: parseInt(row[1]),  
                    role: (row[2] || "").split(',').map(r => r.trim()), 
                    jobId: row[3], workName: row[4], jobTitle: row[5], moduleId: row[6]
                })).filter(t => !isNaN(t.week) && t.workName);
                const newStaffMap = {};
                staffRows.slice(1).forEach(row => { if (row[0] && row[1]) newStaffMap[row[0]] = row[1]; });
                const newLibrary = {};
                libRows.slice(1).forEach(row => {
                    const workKey = row[2]; const stepContent = row[4];
                    if (workKey && stepContent) { if (!newLibrary[workKey]) newLibrary[workKey] = []; newLibrary[workKey].push(stepContent); }
                });

                const syncData = { tasks: newTasks, staff: newStaffMap, library: newLibrary, lastSync: new Date().toISOString() };
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(window.db, 'artifacts', 'yl-command', 'public', 'data', 'master_tasks', 'config'), syncData);
                await localDB.save("master_config", syncData); // å‚™ä»½è‡³ IndexedDB
                alert("âœ… é›²ç«¯èˆ‡æœ¬åœ°åŒæ­¥æˆåŠŸï¼");
            } catch (error) { alert("âŒ åŒæ­¥å¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯æˆ–è©¦ç®—è¡¨è¨­å®šã€‚"); } finally {
                btn.innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4"></i> åŒæ­¥æ•¸æ“šåº«`;
                lucide.createIcons();
            }
        };

        // --- UI æ§åˆ¶ ---
        window.switchView = function(mode) {
            window.viewMode = mode;
            ['btn-daily', 'btn-weekly', 'btn-all'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.className = (id === `btn-${mode}`) ? 'px-6 py-3 rounded-2xl text-sm font-black bg-indigo-600 text-white shadow-xl transition-all' : 'px-6 py-3 rounded-2xl text-sm font-black text-slate-400 hover:text-slate-600 transition-all';
            });
            renderSystem();
        };

        window.handleDateChange = (e) => { window.selectedDate = e.target.value; window.loadDailyStatus(window.selectedDate); };
        window.goToday = () => { const t = new Date().toISOString().split('T')[0]; document.getElementById('date-picker').value = t; window.selectedDate = t; window.loadDailyStatus(t); };

        function renderSystem() {
            const { weekNum, dayOfWeek } = window.calculateCurrentWeek(window.selectedDate);
            const weekInfo = WEEK_LOGIC[weekNum];
            if (document.getElementById('batch-card')) document.getElementById('batch-card').className = `glass-card p-10 rounded-[48px] shadow-sm border border-slate-100 animate-fade ${weekInfo.class}`;
            if (document.getElementById('week-title')) document.getElementById('week-title').innerText = weekInfo.name;
            if (document.getElementById('week-desc')) document.getElementById('week-desc').innerText = weekInfo.desc;
            if (document.getElementById('batch-type-label')) document.getElementById('batch-type-label').innerText = weekInfo.name.split(' ')[0];

            const sections = document.getElementById('staff-sections');
            if (!sections) return;
            sections.innerHTML = '';

            if (window.viewMode === 'daily') renderDailyView(weekNum, dayOfWeek, sections);
            else if (window.viewMode === 'weekly') renderWeeklyView(weekNum, sections);
            else renderAllWBSView(sections);
            lucide.createIcons();
            updateOnlineStatus();
        }

        function renderDailyView(weekNum, dayOfWeek, container) {
            let total = 0, done = 0;
            STAFF_ROLES.forEach(role => {
                const roleTasks = masterTasks.filter(t => normalizeRoles(t.role).includes(role.id) && t.week === weekNum && (t.day === dayOfWeek || (t.day === 7 && dayOfWeek === 0)));
                if (roleTasks.length === 0) return;
                const actualName = staffMapping[role.id] ? ` (${staffMapping[role.id]})` : "";
                const card = document.createElement('div');
                card.className = "glass-card p-8 rounded-[40px] border border-slate-100 shadow-sm animate-fade flex flex-col";
                let html = `<div class="flex items-center gap-4 mb-8"><div class="p-3.5 rounded-2xl ${role.bgColor} ${role.color} shadow-inner"><i data-lucide="${role.icon}" class="w-7 h-7"></i></div><div><h3 class="text-xl font-black text-slate-800 leading-tight">${role.name}</h3><p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">${actualName}</p></div></div><div class="space-y-4">`;
                roleTasks.forEach(task => {
                    total++; const isDone = dailyProgress[task.id] || false; if (isDone) done++;
                    const modInfo = MODULE_MAP[task.moduleId] || { title: "", color: "text-slate-400" };
                    const roles = normalizeRoles(task.role);
                    let staffNames = roles.map(rid => staffMapping[rid] || rid).join(' & ');
                    html += `
                        <div class="flex flex-col gap-1 p-6 rounded-[32px] transition-all ${isDone ? 'bg-emerald-50 border-emerald-100 shadow-inner' : 'bg-slate-50 border-transparent hover:bg-white hover:shadow-xl'} border relative group">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex flex-col gap-1">
                                    <span class="text-[9px] font-black uppercase tracking-tighter ${modInfo.color}">${task.moduleId ? `[MOD ${task.moduleId}] ${modInfo.title}` : 'ä¸€èˆ¬ä»»å‹™'}</span>
                                    <span class="text-[8px] font-black text-indigo-500 bg-indigo-50 px-1.5 py-0.5 rounded-md w-fit flex items-center gap-1 uppercase">è² è²¬äºº: ${staffNames}</span>
                                </div>
                                <button onclick="window.toggleTask('${task.id}')" class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isDone ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 group-hover:border-indigo-500'}">${isDone ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</button>
                            </div>
                            <div class="cursor-pointer" onclick="window.openSOPDetail('${task.moduleId}', '${task.workName}')">
                                <h4 class="font-black text-slate-900 text-base mb-1 tracking-tight">${task.workName}</h4>
                                <div class="flex items-center gap-2"><p class="text-sm font-bold text-slate-500 leading-snug flex-1">${task.jobTitle}</p><i data-lucide="arrow-right-circle" class="w-4 h-4 text-slate-200 group-hover:text-indigo-500 transition-colors"></i></div>
                            </div>
                        </div>`;
                });
                card.innerHTML = html + `</div>`;
                container.appendChild(card);
            });
            if (document.getElementById('task-ratio')) document.getElementById('task-ratio').innerText = `${done}/${total}`;
            if (document.getElementById('overall-progress')) document.getElementById('overall-progress').style.width = `${total > 0 ? (done/total)*100 : 0}%`;
        }

        function renderWeeklyView(weekNum, container) {
            container.className = "grid grid-cols-1 gap-8"; 
            for (let d = 1; d <= 7; d++) {
                const tasks = masterTasks.filter(t => t.week === weekNum && t.day === d);
                if (tasks.length === 0) continue;
                const dayBlock = document.createElement('div');
                dayBlock.className = "glass-card p-10 rounded-[48px] border border-slate-100 shadow-sm animate-fade";
                let dayHtml = `<div class="flex items-center gap-5 mb-8"><div class="w-16 h-16 rounded-[24px] bg-slate-900 text-white flex flex-col items-center justify-center shadow-lg"><span class="text-xs font-black uppercase tracking-widest">${DAY_NAMES[d % 7]}</span></div><h3 class="text-2xl font-black text-slate-800 tracking-tighter">ç•¶æ—¥æµç¨‹</h3></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                tasks.forEach(task => {
                    let staffLabels = normalizeRoles(task.role).map(rid => {
                        const r = STAFF_ROLES.find(sr => sr.id === rid);
                        return `<span class="text-[9px] font-black px-2 py-1 rounded-lg ${r?.bgColor || 'bg-slate-100'} ${r?.color || 'text-slate-400'} uppercase mr-1 inline-block mb-1">${staffMapping[rid] || r?.name || rid}</span>`;
                    }).join('');
                    dayHtml += `<div class="p-6 rounded-[32px] bg-white border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer" onclick="window.openSOPDetail('${task.moduleId}', '${task.workName}')"><div class="flex flex-wrap gap-1.5 mb-4">${staffLabels}</div><p class="text-[10px] font-black text-indigo-500 mb-1 tracking-widest uppercase">ID ${task.jobId}</p><h4 class="font-black text-slate-800 text-base mb-1">${task.workName}</h4><p class="text-xs font-bold text-slate-400 leading-relaxed">${task.jobTitle}</p></div>`;
                });
                dayBlock.innerHTML = dayHtml + `</div>`;
                container.appendChild(dayBlock);
            }
        }

        function renderAllWBSView(container) {
            container.className = "grid grid-cols-1 gap-16";
            WEEK_LOGIC.forEach(weekInfo => {
                const sec = document.createElement('div');
                let html = `<div class="flex items-center gap-6 border-b-4 ${weekInfo.class.replace('border-top', 'border-bottom')} pb-6 mb-10"><h2 class="text-4xl font-black text-slate-900">${weekInfo.name}</h2></div><div class="space-y-12">`;
                for (let d = 1; d <= 7; d++) {
                    const tasks = masterTasks.filter(t => t.week === weekInfo.id && t.day === d);
                    if (tasks.length === 0) continue;
                    html += `<div class="flex flex-col lg:flex-row gap-10"><div class="lg:w-32 font-black text-2xl text-slate-200 uppercase tracking-widest">${DAY_NAMES[d % 7]}</div><div class="flex-1 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
                    tasks.forEach(t => {
                        let names = normalizeRoles(t.role).map(rid => staffMapping[rid] || rid).join(', ');
                        html += `<div class="p-6 rounded-[32px] bg-white border border-slate-100 shadow-sm cursor-pointer hover:shadow-md transition-all" onclick="window.openSOPDetail('${t.moduleId}', '${t.workName}')"><span class="text-[8px] font-black text-indigo-500 block mb-2 uppercase">${names}</span><h4 class="font-black text-slate-800 text-sm mb-1">${t.workName}</h4><p class="text-[10px] font-bold text-slate-400">${t.jobTitle}</p></div>`;
                    });
                    html += `</div></div>`;
                }
                sec.innerHTML = html + `</div>`;
                container.appendChild(sec);
            });
        }

        window.openSOPDetail = function(moduleId, workName) {
            const steps = sopLibraryData[workName];
            const moduleName = MODULE_MAP[moduleId]?.title || "æ¨™æº–ä½œæ¥­è¦ç¯„";
            document.getElementById('sop-modal-title').innerText = workName;
            document.getElementById('sop-modal-tag').innerText = `MOD ${moduleId} | ${moduleName}`;
            const stepsContainer = document.getElementById('sop-modal-steps');
            if (steps && steps.length > 0) {
                stepsContainer.innerHTML = steps.map((s, i) => `<div class="flex gap-6 p-6 bg-slate-50 rounded-[28px] mb-4 hover:bg-white transition-all group shadow-sm"><div class="w-10 h-10 flex-shrink-0 bg-white rounded-xl flex items-center justify-center font-black text-sm text-indigo-600 shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-colors">${i+1}</div><div class="flex-1 pt-1"><p class="text-base font-bold text-slate-700 leading-relaxed">${s}</p></div></div>`).join('');
            } else {
                stepsContainer.innerHTML = `<div class="py-20 text-center text-slate-300 font-bold"><p>å°šæœªå®šç¾©è©³ç´°æ­¥é©Ÿã€‚</p></div>`;
            }
            document.getElementById('sop-modal-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        };

        window.closeSOPModal = () => { document.getElementById('sop-modal-overlay').classList.add('hidden'); document.body.style.overflow = ''; };
        window.checkPasscode = () => { if (document.getElementById('passcode-input').value === MASTER_PASSCODE) { sessionStorage.setItem('yl_auth', 'true'); document.getElementById('auth-overlay').classList.add('hidden'); startSystem(); } };
        function startSystem() { onAuthStateChanged(auth, (u) => { if (u) { loadAllData(); window.loadDailyStatus(window.selectedDate); } else { signInAnonymously(auth); } }); }
        
        window.onload = () => {
            if (sessionStorage.getItem('yl_auth') === 'true') { document.getElementById('auth-overlay').classList.add('hidden'); startSystem(); }
            document.getElementById('date-picker').value = window.selectedDate;
            updateOnlineStatus();
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .batch-breeding { border-top: 14px solid #3b82f6; } 
        .batch-farrowing { border-top: 14px solid #10b981; } 
        .batch-weaning { border-top: 14px solid #f59e0b; }   
        .batch-breeding.border-bottom { border-bottom: 10px solid #3b82f6; border-top: none; }
        .batch-farrowing.border-bottom { border-bottom: 10px solid #10b981; border-top: none; }
        .batch-weaning.border-bottom { border-bottom: 10px solid #f59e0b; border-top: none; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .animate-fade { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- é©—è­‰ä»‹é¢ (ç•¥) -->
    <div id="auth-overlay" class="fixed inset-0 z-[2000] bg-slate-900 flex items-center justify-center p-6">
        <div class="max-w-md w-full bg-white rounded-[48px] p-12 shadow-2xl text-center">
            <h2 class="text-3xl font-black text-slate-900 mb-8 tracking-tighter">æ°¸éš†æ™ºæ…§ä¸­å¿ƒ</h2>
            <input type="password" id="passcode-input" placeholder="PASSCODE" class="w-full px-6 py-5 bg-slate-50 rounded-2xl text-center text-3xl font-black mb-6 outline-none border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all tracking-[0.3em]">
            <button onclick="window.checkPasscode()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-lg active:scale-95 transition-all shadow-xl shadow-indigo-100">å•Ÿå‹•é›¢ç·š APP</button>
        </div>
    </div>

    <header class="sticky top-0 z-50 glass-card border-b border-slate-200/60 px-6 py-6">
        <div class="max-w-[1600px] mx-auto flex flex-col xl:flex-row items-center justify-between gap-6">
            <div class="flex items-center gap-6">
                <div class="bg-slate-900 p-4 rounded-[24px] shadow-2xl"><i data-lucide="zap" class="w-8 h-8 text-white"></i></div>
                <div>
                    <h1 class="text-2xl font-black text-slate-900 tracking-tighter mb-1 leading-none">æ°¸éš†æŒ‡æ®ä¸­å¿ƒ</h1>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                            <span id="network-status-dot" class="w-2 h-2 rounded-full bg-emerald-500"></span>
                            <span id="network-status-text" class="text-[10px] font-black text-slate-500 uppercase tracking-widest">é€£ç·šåŒæ­¥ä¸­</span>
                        </div>
                        <div class="flex items-center gap-2 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">
                            <span id="local-status-dot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                            <span class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">æœ¬åœ°æŒä¹…åŒ–</span>
                        </div>
                        <input type="date" id="date-picker" onchange="window.handleDateChange(event)" class="text-[11px] font-black text-indigo-600 bg-transparent border-none outline-none cursor-pointer">
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-1.5 bg-slate-100 p-2 rounded-3xl shadow-inner">
                <button id="btn-daily" onclick="window.switchView('daily')" class="px-6 py-3 rounded-2xl text-sm font-black bg-indigo-600 text-white shadow-xl transition-all">ä»Šæ—¥çœ‹æ¿</button>
                <button id="btn-weekly" onclick="window.switchView('weekly')" class="px-6 py-3 rounded-2xl text-sm font-black text-slate-400 hover:text-slate-600 transition-all">é€±çœ‹æ¿</button>
                <button id="btn-all" onclick="window.switchView('all')" class="px-6 py-3 rounded-2xl text-sm font-black text-slate-400 hover:text-slate-600 transition-all">å…¨æ¡ˆç¸½è¦½</button>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="window.goToday()" class="text-xs bg-white border border-slate-200 px-6 py-3 rounded-2xl hover:bg-indigo-600 hover:text-white transition-all shadow-sm font-black tracking-widest">å›ä»Šæ—¥</button>
                <button id="sync-btn" onclick="window.requestSync()" class="flex items-center gap-2 px-6 py-3 rounded-2xl bg-slate-900 text-white font-black text-sm shadow-xl transition-all"><i data-lucide="refresh-cw" class="w-4 h-4"></i>åŒæ­¥æ•¸æ“šåº«</button>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto px-6 py-10">
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <div id="batch-card" class="glass-card p-12 rounded-[56px] shadow-sm border border-slate-100 animate-fade">
                <p class="text-[11px] font-black text-slate-400 uppercase mb-4 tracking-widest">é€±æœŸç‹€æ…‹</p>
                <h2 id="week-title" class="text-5xl font-black text-slate-900 mb-2 tracking-tighter">-- é€±</h2>
                <p id="week-desc" class="text-base text-slate-500 font-medium leading-relaxed">æ­£åœ¨è¨ˆç®—ä¸­...</p>
            </div>
            <div class="glass-card p-12 rounded-[56px] shadow-sm border border-slate-100 animate-fade">
                <p class="text-[11px] font-black text-slate-400 uppercase mb-4 tracking-widest">ä»»å‹™é€²åº¦çµ±è¨ˆ</p>
                <div class="flex items-end gap-5">
                    <h2 id="task-ratio" class="text-6xl font-black text-slate-900 tabular-nums">0/0</h2>
                    <p class="text-lg font-black text-slate-400 mb-1 uppercase">COMPLETED</p>
                </div>
                <div class="w-full h-3 bg-slate-100 rounded-full mt-8 overflow-hidden shadow-inner"><div id="overall-progress" class="h-full bg-indigo-600 transition-all duration-1000 ease-out" style="width: 0%"></div></div>
            </div>
        </section>
        <div id="staff-sections" class="grid grid-cols-1 lg:grid-cols-2 gap-12"></div>
    </main>

    <div id="sop-modal-overlay" class="fixed inset-0 z-[3000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 md:p-8 hidden">
        <div class="bg-white w-full max-w-3xl rounded-[56px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade">
            <div class="p-10 border-b border-slate-100 flex justify-between items-start bg-slate-50/50">
                <div>
                    <span id="sop-modal-tag" class="text-[10px] font-black px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 uppercase mb-4 block w-fit tracking-widest"></span>
                    <h3 id="sop-modal-title" class="text-4xl font-black text-slate-900 leading-tight"></h3>
                </div>
                <button onclick="window.closeSOPModal()" class="p-4 text-slate-300 hover:text-rose-500 transition-all"><i data-lucide="x" class="w-8 h-8"></i></button>
            </div>
            <div id="sop-modal-steps" class="p-10 overflow-y-auto space-y-2"></div>
            <div class="p-8 bg-white border-t border-slate-50 flex justify-center">
                <button onclick="window.closeSOPModal()" class="px-16 py-5 bg-slate-900 text-white rounded-[24px] font-black text-lg active:scale-95 transition-all shadow-2xl">äº†è§£ï¼Œæˆ‘æœƒæŒ‰æ­¥é©ŸåŸ·è¡Œ</button>
            </div>
        </div>
    </div>
</body>
</html>
